<h1>Choose a team name and make your picks</h1>
<p>You can come back and upate these before midnight on 31st Decemeber 2019.</p>
<%= form_for(@team, url: teams_path) do |f| %>
  <%= render 'shared/team_error_messages' %>
  <%= f.label :name, 'Your team name' %>
  <%= f.text_field :name, required: true %>

  <%= f.fields_for :picks do |pick| %>
    <% competition = @competitions[pick.index] %>
    <%= pick.label competition.name %>
    <%= pick.collection_select :competitor_id, @competitors.select { |competitor| competitor.competition_id == competition.id }, :id , :name, include_blank: false %>
  <% end %>

  <div id="team_captain_id"></div>

  <%= f.submit 'Submit' %>

  <% content_for :javascript do %>
    <script type="text/javascript">
      $(document).on('turbolinks:load', function() {
        var competitons = $('select') // we don't want to select the captain dropdown
        var pickIds = []
        var currentCaptainId;

        function initialize() {
          setInitialOptions();
          listenForSelectionChanges();
          listendForCurrentCaptainSelection();
        }

          function setInitialOptions() {
          pickIds = getCurrentPickIds();
          currentCaptainId = '<%= @current_captain.id %>';
          postData(pickIds, currentCaptainId);
        };

        function listenForSelectionChanges() {
          competitons.each(function() {
            $(this).change(function() {
              updateOptions();
            });
          });
        };

        function listendForCurrentCaptainSelection() {
          $('#team_captain_id').change(function() {
            currentCaptainId = getCurrentCaptainId();
            pickIds = getCurrentPickIds();
            postData(pickIds, currentCaptainId);
          });
        }

        function getCurrentCaptainId() {
          return $('#team_captain_id :selected').val();
        }

        function getCurrentPickIds() {
          pickIds = []
          competitons.each(function() {
            pickIds.push($(this).val())
          });
          return pickIds;
        };

        function updateOptions() {
          var prevPickIds = pickIds;
          pickIds = getCurrentPickIds()
          currentCaptainId = getCurrentCaptainId();
          // if user replaces their current captain selecion, replace with replacement selection
          if (!pickIds.includes(currentCaptainId) && prevPickIds.length > 0) {
            prevCaptainIndex = prevPickIds.indexOf(currentCaptainId)
            currentCaptainId = pickIds[prevCaptainIndex]
          }
          postData(pickIds, currentCaptainId);
        };

        function postData(pickIds, currentCaptainId) {
          console.log(pickIds, currentCaptainId)
          $.post("/set_captain_options", {data: {captainOptions : pickIds, currentCaptainId : currentCaptainId}}, function(data, status) {
            if (status != "success") {
              alert('Woah, we couldn"t update the captain choices. Please try again or contact us if the problem persists.');
            }
          });
          return true;
        };

        initialize();
      });
    </script>
  <% end %>
<% end %>

